<!DOCTYPE html>
<html lang="ja">
<head>

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>管理画面 - otsuki-mart</title>
</head>
<body>
  <h1>管理画面</h1>

  <section>
    <h2>お知らせ編集</h2>
    <textarea id="news-input" rows="6" style="width: 100%;"></textarea>
    <button id="save-news">保存</button>
  </section>

  <section>
    <h2>店舗情報編集</h2>
    <textarea id="store-input" rows="4" style="width: 100%;"></textarea>
    <button id="save-store">保存</button>
  </section>

  <section>
    <h2>社員情報編集</h2>
    <textarea id="staff-input" rows="8" style="width: 100%;" placeholder="CSV形式: 名前,役職,店舗"></textarea>
    <button id="save-staff">保存</button>
  </section>

  <p id="message" style="color: green;"></p>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js"></script>

  <script>
    // Firebase初期設定
    const firebaseConfig = {
      apiKey: "AIzaSyBMhTeuoHLqZ1E0IRu7jfJcE9fvrZfAFgM",
      authDomain: "otsuki-mart.firebaseapp.com",
      databaseURL: "https://otsuki-mart-default-rtdb.firebaseio.com",
      projectId: "otsuki-mart",
      storageBucket: "otsuki-mart.firebasestorage.app",
      messagingSenderId: "970391222743",
      appId: "1:970391222743:web:81d6a31285c92da4a2f392",
      measurementId: "G-N7577RSBW6"
    };

    // Firebase初期化
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ページ読み込み時にデータ取得
    window.onload = function() {
      db.ref('/').get().then(snapshot => {
        if (snapshot.exists()) {
          const data = snapshot.val();
          if (data.news) document.getElementById('news-input').value = data.news.join('\n');
          if (data.storeInfo) document.getElementById('store-input').value = data.storeInfo;
          if (data.staff) {
            const csv = data.staff.map(s => `${s.name},${s.position},${s.store}`).join('\n');
            document.getElementById('staff-input').value = csv;
          }
        }
      }).catch(error => {
        alert('データ読み込みエラー: ' + error.message);
      });
    };

    // メッセージ表示関数
    function showMessage(msg, isError = false) {
      const p = document.getElementById('message');
      p.style.color = isError ? 'red' : 'green';
      p.textContent = msg;
      setTimeout(() => { p.textContent = ''; }, 3000);
    }

    // 保存ボタンイベント
    document.getElementById('save-news').onclick = function() {
      const val = document.getElementById('news-input').value.trim();
      const arr = val.split(/\r?\n/).filter(line => line);
      db.ref('news').set(arr)
        .then(() => showMessage('お知らせを保存しました。'))
        .catch(e => showMessage('保存エラー: ' + e.message, true));
    };

    document.getElementById('save-store').onclick = function() {
      const val = document.getElementById('store-input').value.trim();
      db.ref('storeInfo').set(val)
        .then(() => showMessage('店舗情報を保存しました。'))
        .catch(e => showMessage('保存エラー: ' + e.message, true));
    };

    document.getElementById('save-staff').onclick = function() {
      const val = document.getElementById('staff-input').value.trim();
      const staffArray = val.split(/\r?\n/).map(line => {
        const parts = line.split(',');
        if (parts.length >= 3) {
          return { name: parts[0].trim(), position: parts[1].trim(), store: parts[2].trim() };
        } else {
          return null;
        }
      }).filter(Boolean);
      db.ref('staff').set(staffArray)
        .then(() => showMessage('社員情報を保存しました。'))
        .catch(e => showMessage('保存エラー: ' + e.message, true));
    };
  </script>
</body>
</html>
